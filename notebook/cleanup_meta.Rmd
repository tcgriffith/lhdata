---
title: "Untitled"
author: "TC"
date: "10/13/2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

knitr::opts_chunk$set(echo = TRUE)
postpath="~/GIT/owaraisite/content/post/"
netapath="~/GIT/owaraisite/content/neta/"


f = c(
  list.files(postpath, full.names = TRUE),
  list.files(netapath, full.names=TRUE))

library(tidyr)
library(dplyr)

```


```{r}

form_list_len1 = function(vector){
  uni_vec= unique(vector)
  if (length(uni_vec) > 1) return(uni_vec)
  else return(list(uni_vec))
}

cleanup_meta = function(fpost) {
  lines = xfun::file_string(fpost)
  content = gsub("^---.*?---\n", "", lines)
  header = gsub("^---(.*?)\n---\n.*", "\\1", lines)
  is.processed = 0
  ## clean post with bangumi in the header
  if (grepl("bangumi:", header)) {
    header.yml = yaml::yaml.load(header)
    
    header.yml = lapply(header.yml, unique)
    
    
    bangumis = header.yml$bangumis
    
    header.yml$bangumis = form_list_len1(header.yml$bangumis)
    header.yml$tags = form_list_len1(header.yml$tags)
    
    header.yml$categories =form_list_len1(header.yml$categories)
    
    full.post = paste0(
      "---\n",
      yaml::as.yaml(header.yml, indent.mapping.sequence = TRUE),
      "---\n",
      content
    )
    
    xfun::write_utf8(full.post, fpost)
    is.processed = 1
  }
  return(is.processed)
}


```





```{r testit, eval=FALSE}

dummy = sapply(f, cleanup_meta)

table(dummy)

```


# update tag from known keywords

test with known geining


```{r}

get_tags = function(vector, known_keys) {
  pattern = paste0("(", paste0(tolower(known_keys), collapse = "|"), ")")

  test = stringr::str_match_all(vector, pattern)
  tags_found = lapply(test, function(mat){
    return(unique(mat[,1]))
  })
  return(tags_found)
}

```


```{r}

testtext ='
+++
title = "岛田绅助"
description = ""
weight = 1
alwaysopen = true
+++


**岛田绅助**，本名**长谷川公彦**，是日本一位[漫才师]({{< ref "漫才" >}})（日式相声）出身的[搞笑艺人]({{< ref "搞笑艺人" >}})、主持人、电影演员与製作人。出生于京都府京都市，京都大谷中学-高中
({{< ref "京都府)毕业。京都学园大学肄业。自称身高有170公分，血型为AB型。所属经纪公司为[吉本兴业](吉本兴业" >}})。

岛田在少年时代曾是暴走族，也曾在寿司店实习过。岛田曾在1975年时与[松本龙介合组双人搞笑组合]({{< ref "松本龙介" >}})“绅助、龙介”，该组合在1985年时解散。

2011年，因和暴力团人士的密切来往，宣布引退。

<!--more-->

## 简历


### 创立M-1大赛

2001年，在吉本兴业的委托：“为了漫才复活，请将你的智慧借给我们”之下，策划了漫才比赛“[M-1
Grand
Prix]({{< ref "M1大赛" >}})”，并担任大会委员长和审查员。在严格的审查之下，[增田冈田]({{< ref "增田冈田" >}})，[Football
hour]({{< ref "足球时间" >}})，[黑色美乃滋]({{< ref "黑色美乃滋" >}})，[Tutorial]({{< ref "Tutorial" >}})，[三明治人等年轻的漫才师横空出世]({{< ref "三明治人" >}})，进入世人的视线；[小木矢作]({{< ref "小木矢作" >}})，[南海甜心]({{< ref "南海甜心" >}})，[奥黛丽等很多组合虽未取得优胜]({{< ref "奥黛丽" >}})，也因该大会而广受欢迎。从2008起，M1大赛关注度和受欢迎程度不断增高，被称为“国家级赛事”(时年，关西地区平均收视率在35%以上，瞬间收视率超过40%)，M1比赛在2010年暂时结束，绅助评论道：“在惋惜声中结束是最好的结果。”

### 伤害事件


2004年10月25日，岛田绅助在[朝日放送录影前]({{< ref "朝日放送" >}})，与[胜谷诚彦的女性经纪人发生口角]({{< ref "胜谷诚彦" >}})，殴打其颈部，令其受伤。2004年10月28日，大坂府警方以伤害事件名义正式起诉岛田绅助；同日，岛田绅助在吉本兴业东京支社记者会中谢罪。为此，吉本兴业处分岛田绅助至2004年11月4日。2004年11月4日，大坂府检察官因此伤害案件证据明确而向大坂简易裁判所提起简式起诉，大坂简易裁判所判决岛田绅助30万日元罚金。

被害女性要求岛田绅助退出演艺圈，但岛田绅助于2005年1月2日回复演艺活动。被害女性于2006年6月自吉本兴业退职，并向东京地方裁判所提出请求诉讼标的达4400万日元的民事损害赔偿诉讼，以及请求确认退职无效。2011年9月22日，本案在东京高等裁判所成立和解。

### 引退


2011年8月21日，岛田绅助被日本媒体报导曾和暴力团成员有密切关系。2011年8月23日，岛田在吉本兴业东京本部举行记者会承认此事并主动宣布引退，而他表示是因为在10年前碰上难以解决的麻烦才找上暴力团协助并有了联系。

## 轶事

-   岛田绅助和[关西杰尼斯8]({{< ref "关西杰尼斯8" >}})（关8）的[村上信五私交甚笃]({{< ref "村上信五" >}})，岛田在《[美味绅助]({{< ref "美味绅助" >}})》裡首次指名与关8合作。由于关8向来走搞笑路线，与一般的[杰尼斯事务所艺人的偶像风格相差甚远]({{< ref "杰尼斯事务所" >}})，所以岛田曾戏谑他们为“假杰尼斯”。

-   在岛田绅助主持的[富士电视台猜谜节目]({{< ref "富士电视台" >}})《[QUIZ!HEXAGON
    II]({{< ref "QUIZ!HEXAGON" >}})》中，固定班底[上地雄辅把日文汉字]({{< ref "上地雄辅" >}})「羞耻心」（Shu-Chi-Shin）误读为「Sa-Ji-Shin」，因此岛田绅助当场对[鹤野刚士]({{< ref "鹤野刚士" >}})、[上地雄辅与]({{< ref "上地雄辅" >}})[野久保直树说]({{< ref "野久保直树" >}})：「你们三个今天开始就叫做『羞耻心
    (组合)』好了」。于是此三人团体在2008年4月9日以岛田绅助填词的单曲《羞耻心》出道，并且囊括ORICON日文单曲排行榜第一名及四月份的销售冠军。

-   岛田绅助于政治上倾向保守主义，曾经在读卖电视台节目上发表过「宪法第九条能修改的话比较好」的谈话。《日本国宪法》载有禁止日本自卫队主动出兵等规范，使该宪法被称为“和平宪法”。岛田绅助自己是以大商人的身份，採取赞助政治活动的立场出席造势活动，本人并无意参选。
'


get_tags(testtext, known_keys= kw_wiki$V1)

# known_keys = geinin_map.s$V1
# 
#   pattern = paste0("(", paste0(tolower(known_keys), collapse = "|"), ")")
# 
#   test = stringr::str_match_all(testtext, pattern)
```


```{r testit2, eval=FALSE}


update_tags = function(fpost, known_keys) {
  lines = xfun::file_string(fpost)
  content = gsub("^---.*?---\n", "", lines)
  header = gsub("^---(.*?)\n---\n.*", "\\1", lines)
  is.processed = 0
  ## clean post with bangumi in the header
  
  if (grepl("bangumi:", header)) {
    header.yml = yaml::yaml.load(header)
    header.yml = lapply(header.yml, unique)
    
    new_tags = unique(c(get_tags(lines, known_keys)[[1]], header.yml$tags))
    
    if (length(new_tags) > length(header.yml$tags)) {
      
      message("...", fpost," tags updated:")
      
      message("...added: ", paste0(new_tags[!new_tags %in% header.yml$tags], collapse=", "))
      
      header.yml$tags = form_list_len1(new_tags)
      header.yml$bangumis = form_list_len1(header.yml$bangumis)
      header.yml$categories = form_list_len1(header.yml$categories)
      full.post = paste0(
        "---\n",
        yaml::as.yaml(header.yml, indent.mapping.sequence = TRUE),
        "---\n",
        content
      )
      xfun::write_utf8(full.post, fpost)
      is.processed = 1
    }
  }
  return(is.processed)
}


```

```{r}
known_tags = data.table::fread(here::here("/data/known_tags.txt"),header=FALSE)
```

```{r}
new_tags=data.table::fread(
"
霜降り明星
Seiya
博多大吉
礼二
小峠
土屋
向井
粗品
眉春千秋
喵星
我们家
坪仓
蛍原徹
山添
濱家
土屋
相田
有吉Japon
瀧野由美子
伊集院光
吉村
澤部
川西
水田
華丸
大吉
超合金
爆笑問題
007
AKB
稻酱
神舌
超合金
高山一実
乃木坂46
"
)[[1]]
```


```{r}
new_tags=data.table::fread(
"
田村亮
指原莉乃
FUJIWARA藤本
", header=FALSE)[[1]]
```


```{r}
kw_wiki = data.table::fread("~/GIT/lhdata/data/kw_wiki.txt", header=FALSE)
```

```{r}
kw_wiki.cln =
  
  kw_wiki %>%
  mutate(strlen = stringr::str_length(V1)) %>%
  arrange(strlen) %>%
  filter(!V1 %in% c("ORIE","JP","orie","jp", "やす")) %>%
  filter(strlen >1)
```



```{r}
dummy = pbapply::pbsapply(f, update_tags, kw_wiki.cln$V1)

table(dummy)

```


